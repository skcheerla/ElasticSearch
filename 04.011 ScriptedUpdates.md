## Scripted Updates in Elasticsearch

![Image](https://miro.medium.com/v2/resize%3Afit%3A1400/0%2AwVDC5SuygZ1OVx8f.png?utm_source=chatgpt.com)

![Image](https://us1.discourse-cdn.com/elastic/original/3X/a/8/a8fe518290a7f9fe7bc2763394b8d201d8611419.png?utm_source=chatgpt.com)

![Image](https://i.sstatic.net/AFjSc.png?utm_source=chatgpt.com)

**Scripted updates** let you modify documents dynamically at update time using scripts (usually **Painless**). Theyâ€™re ideal when the new value depends on the **existing document state**.

---

## ğŸ”¹ What Happens Under the Hood

1. Elasticsearch fetches the document
2. Runs the script against `_source`
3. Reindexes the modified document (updates are delete + reindex)

---

## 1ï¸âƒ£ Basic Scripted Update (Increment a Field)

```http
POST my_index/_update/1
{
  "script": {
    "source": "ctx._source.experience += 1"
  }
}
```

âœ” Common for counters, retries, views

---

## 2ï¸âƒ£ Script with Parameters (Best Practice)

```http
POST my_index/_update/1
{
  "script": {
    "source": "ctx._source.experience += params.inc",
    "params": {
      "inc": 2
    }
  }
}
```

âœ” Safer
âœ” Reusable
âœ” Avoids script recompilation

---

## 3ï¸âƒ£ Conditional Scripted Update

```http
POST my_index/_update/1
{
  "script": {
    "source": """
      if (ctx._source.status == 'active') {
        ctx._source.last_login = params.now;
      }
    """,
    "params": {
      "now": "2025-01-01T10:00:00"
    }
  }
}
```

âœ” Update only when conditions match

---

## 4ï¸âƒ£ Create Field If Missing

```http
POST my_index/_update/1
{
  "script": {
    "source": """
      if (!ctx._source.containsKey('login_count')) {
        ctx._source.login_count = 1;
      } else {
        ctx._source.login_count += 1;
      }
    """
  }
}
```

---

## 5ï¸âƒ£ Scripted Upsert (Update or Insert)

```http
POST my_index/_update/2
{
  "script": {
    "source": "ctx._source.count += params.inc",
    "params": { "inc": 1 }
  },
  "upsert": {
    "count": 1
  }
}
```

âœ” If document doesnâ€™t exist â†’ uses `upsert`

---

## 6ï¸âƒ£ Update Multiple Documents with Script (`update_by_query`)

```http
POST my_index/_update_by_query
{
  "query": {
    "term": {
      "role.keyword": "SRE"
    }
  },
  "script": {
    "source": "ctx._source.team = 'platform'"
  }
}
```

âš ï¸ Heavy operation
âœ” Use during low traffic
âœ” Can throttle with `requests_per_second`

---

## 7ï¸âƒ£ Delete a Document Using Script

```http
POST my_index/_update/1
{
  "script": {
    "source": "ctx.op = 'delete'"
  }
}
```

âœ” Conditional deletes possible

---

## ğŸ” Script Security & Settings

* Default language: **Painless**
* Inline scripts: enabled by default
* Stored scripts: preferred for reuse & safety

Example stored script usage:

```http
POST _scripts/increment_counter
{
  "script": {
    "lang": "painless",
    "source": "ctx._source.count += params.inc"
  }
}
```

---

## ğŸ§  When to Use Scripted Updates

âœ… Counters / metrics
âœ… Conditional logic
âœ… Partial updates based on state

âŒ High-frequency hot-path writes
âŒ Massive bulk updates (prefer reindex)

---

## âš ï¸ Common Pitfalls

| Issue             | Fix                         |
| ----------------- | --------------------------- |
| High CPU usage    | Use params & stored scripts |
| Version conflicts | Use `retry_on_conflict`     |
| Mapping errors    | Validate field types        |
| Slow updates      | Avoid complex scripts       |

---

## ğŸ¯ Interview-Ready Answer

> *â€œScripted updates in Elasticsearch use Painless scripts to modify documents dynamically. They are executed during update or update_by_query operations and are useful for counters, conditional updates, and derived fields, but must be used carefully due to performance impact.â€*

---

If you want, next I can explain:

* Painless language basics
* Stored vs inline scripts
* Reindex vs scripted updates
* Real production incidents & tuning tips

Just say ğŸ‘
